CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE TABLE users
(
    uuid          UUID DEFAULT uuid_generate_v4(),
    id            BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL PRIMARY KEY,
    login         VARCHAR(50)                             NOT NULL UNIQUE,
    name          VARCHAR(50)                             NOT NULL,
    surname       VARCHAR(50)                             NOT NULL,
    role          VARCHAR(50)                             NOT NULL,
    email         VARCHAR(50)                             NOT NULL UNIQUE,
    password      VARCHAR(50)                             NOT NULL,
    cost_per_hour NUMERIC                                 NOT NULL
);

CREATE TABLE projects
(
    uuid        UUID DEFAULT uuid_generate_v4(),
    id          BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL PRIMARY KEY,
    name        VARCHAR(50)                             NOT NULL UNIQUE,
    description VARCHAR(1000),
    start       TIMESTAMP,
    stop        TIMESTAMP,
    budget      NUMERIC CHECK (BUDGET > 0),
    user_id     BIGINT,
    FOREIGN KEY (user_id) REFERENCES users (id)
);

CREATE TABLE time_records
(
    uuid        UUID DEFAULT uuid_generate_v4(),
    id          BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL PRIMARY KEY,
    start       TIMESTAMP,
    stop        TIMESTAMP,
    project_id  BIGINT,
    user_id     BIGINT,
    FOREIGN KEY (project_id) REFERENCES projects (id),
    FOREIGN KEY (user_id) REFERENCES users (id)
);

alter table users
    add project_id bigint;

alter table users
    ADD FOREIGN KEY (project_id) REFERENCES projects (id);


create table project_user
(
    user_id    int8 not null primary key,
    project_id int8 not null primary key,
    foreign key (user_id) references users (id)
        on delete cascade,
    foreign key (project_id) references projects (id)
        on delete cascade
);

create table time_records
(
    uuid       uuid default uuid_generate_v4(),
    id         bigint generated by default as identity primary key,
    start      timestamp,
    stop       timestamp,
    project_id bigint
        references projects,
    user_id    bigint
        references users
);

--after change

CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE TABLE users
(
    uuid          UUID DEFAULT uuid_generate_v4(),
    id            BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL PRIMARY KEY,
    login         VARCHAR(50)                             NOT NULL UNIQUE,
    name          VARCHAR(50)                             NOT NULL,
    surname       VARCHAR(50)                             NOT NULL,
    role          VARCHAR(50)                             NOT NULL,
    email         VARCHAR(50)                             NOT NULL UNIQUE,
    password      VARCHAR(50)                             NOT NULL,
    cost_per_hour NUMERIC                                 NOT NULL,
    projects_id     BIGINT
);
CREATE TABLE projects
(
    uuid        UUID DEFAULT uuid_generate_v4(),
    id          BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL PRIMARY KEY,
    name        VARCHAR(50)                             NOT NULL UNIQUE,
    description VARCHAR(1000),
    start       TIMESTAMP,
    stop        TIMESTAMP,
    budget      NUMERIC CHECK (BUDGET > 0),
    users_id     BIGINT
);
CREATE TABLE project_user
(
    project_id 		BIGINT 						    NOT NULL,
    user_id   	 	BIGINT 							NOT NULL,
    enter_on        TIMESTAMP,
    leave_on        TIMESTAMP,
    PRIMARY KEY (project_id, user_id),
    foreign key (user_id) references users (id)
        on delete cascade,
    foreign key (project_id) references projects (id)
        on delete cascade
);

alter table users
    ADD FOREIGN KEY (projects_id) REFERENCES project_user(project_id);

alter table projects
    ADD FOREIGN KEY (users_id) REFERENCES project_user(user_id);

create table project_user_id (
    project_id 		BIGINT 						    NOT NULL,
    user_id   	 	BIGINT 							NOT NULL
)